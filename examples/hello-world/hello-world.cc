#include <types.h>
#include <gba.h>

#define MAP_BASE ((volatile u16_t*)0x06008000)  // Screen Block 31

#define CHARBLOCK_0 (0 << 2)
#define SCREENBLOCK_31 (0 << 8)
#define BG_SIZE_0 (0 << 14)

static auto const TILEMAP_PTR = (volatile u16_t*)(0x06000000 + 1 * 0x800);
static auto const TILESET_PTR = (volatile u16_t*)(0x06000000 + 0 * 0x400);

void setup_graphics() {
    *REG_DISPCNT = MODE_0 | BG0_ENABLE;
    *REG_BG0CNT = 
      (0b00    << 0)  | // Priority 0 (Highest)
      (0b00    << 2)  | // Start addr of tile data 0x06000000 + S * 0x4000
      (0b00    << 4)  | // Unused
      (0b0     << 6)  | // Mosaic effect 0 (Off)
      (0b0     << 7)  | // Use 16 color map
      (0b00001 << 8)  | // Starting addr of tile map 0x06000000 + M * 0x800
      (0b0     << 13) | // Screen over / RO
      (0b00    << 15)   // Size of tile map. 0 means 32x32
    ;

    const u16_t tile_data[] = {
0x0000, 0x0000, 0x1100, 0x0011, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0011, 0x0100, 0x0010, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0001, 0x0100, 0x0010, 0x1100, 0x0011, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0011, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x1100, 0x0011, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0011, 0x0100, 0x0000, 0x0100, 0x0000, 0x1100, 0x0001, 0x0100, 0x0000, 0x1100, 0x0011, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0011, 0x0100, 0x0000, 0x0100, 0x0000, 0x1100, 0x0001, 0x0100, 0x0000, 0x0100, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x1000, 0x0011, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0011, 0x0100, 0x0010, 0x1000, 0x0011, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0011, 0x0100, 0x0010, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x1000, 0x0000, 0x0000, 0x0000, 0x1000, 0x0000, 0x1000, 0x0000, 0x1000, 0x0000, 0x1000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x0000, 0x0001, 0x0000, 0x0000, 0x0000, 0x0001, 0x0000, 0x0001, 0x0100, 0x0001, 0x1000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x0100, 0x0001, 0x1100, 0x0000, 0x1100, 0x0000, 0x0100, 0x0001, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x0100, 0x0000, 0x1100, 0x0011, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0110, 0x1100, 0x0110, 0x0100, 0x0101, 0x0100, 0x0101, 0x0100, 0x0100, 0x0100, 0x0100, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x1100, 0x0010, 0x1100, 0x0010, 0x0100, 0x0011, 0x0100, 0x0011, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x1000, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x1000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0001, 0x0100, 0x0000, 0x0100, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x1000, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0011, 0x1000, 0x0111, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x1100, 0x0001, 0x0100, 0x0001, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x1000, 0x0011, 0x0100, 0x0000, 0x0100, 0x0000, 0x1000, 0x0001, 0x0000, 0x0010, 0x1100, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0111, 0x0000, 0x0001, 0x0000, 0x0001, 0x0000, 0x0001, 0x0000, 0x0001, 0x0000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x0100, 0x0010, 0x1000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0100, 0x0100, 0x0100, 0x0100, 0x0100, 0x1000, 0x0010, 0x1000, 0x0010, 0x0000, 0x0001, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0101, 0x0100, 0x0101, 0x0100, 0x0101, 0x1000, 0x0010, 0x1000, 0x0010, 0x1000, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x0100, 0x0010, 0x1000, 0x0001, 0x1000, 0x0001, 0x0100, 0x0010, 0x0100, 0x0010, 0x0000, 0x0000,
0x0000, 0x0000, 0x0100, 0x0010, 0x1000, 0x0010, 0x0000, 0x0011, 0x0000, 0x0001, 0x1000, 0x0000, 0x0100, 0x0000, 0x0000, 0x0000,
0x0000, 0x0000, 0x1100, 0x0011, 0x0000, 0x0010, 0x0000, 0x0001, 0x0000, 0x0001, 0x1000, 0x0000, 0x1100, 0x0011, 0x0000, 0x0000,
    };

    BG_PALETTE[0] = 0x0000;
    BG_PALETTE[1] = (0x1f << 0) | (0x1f << 5) | (0x1f << 10);
    for (int i = 0; i < 16 * 26; i++) {
        TILESET_PTR[16 + i] = tile_data[i];
    }
}

void print(u16_t x, u16_t y, const char* message)
{
    const char* c = message;
    u16_t i = 0;
    while (*c != '\0') {
        TILEMAP_PTR[32*y + x + i] = (u16_t{*c} - 65) + 1;
        c++;
        i++;
    }
}

int main() {
    setup_graphics();
    for (int i = 0; i < 26; ++i) {
        TILEMAP_PTR[i] = i;
    }
    print(3, 3, "HELLO WORLD");
    while (1);
}

